---
_vars:
  - time: 0 # Measured in days
  # Logic vars
  - temp: 0
  - is_expedition_day: False
  - on_training_expedition: False
  - num_training_expeditions: 0
  # Progress vars
  - tunnel_pass: training
  # Research vars
  - research_botany_1_chapter: 0
  - research_reading_1_chapter: 0
  # Skill vars
  - skill_lemen: 3
    _locale: Lemen Gathering Skill
  # Personal vars
  # TODO: Ability to inspect self and see what clothes you're wearing
  - curr_clothes: light_gray_plain
  - clothes_owned_light_gray_plain: true
  - clothes_owned_dark_gray_plain: true
  # Inventory vars
  - coin: 0
    _locale: Coin
  # TODO: Add lemen spoilage
  # TODO: Add unlock for lemens
  - lemens: 0
    _locale: Lemens
  - rosalia: 0
    _locale: Rosalia
  # Misc. vars
  - time_last_explored: 0
  - time_next_training: 0
  - orphanage_rooms_george_num_times_nvm_in_a_row: 0
  - orphanage_rooms_george_num_times_chatted_things_in_a_row: 0
  - orphanage_rooms_personal_last_day_slept: 0
_content:
  # Skip to first free day
  - command: input ready, walk, gather, return, next, exciting, give, next
  # Skip to the second free day
  - command: input leave, common, study, botany, next, next, leave, george, embark, next, focus, return, accept, accept, next
  - goto: tunnel/training/first_journey/george_waiting
_header:
  - choice: encyclopedia
    action:
    effects:
      - "Rosalia: Rosalia is a rose-like plant with big, broad, deep red leaves and smaller leaves along its stem. These smaller leaves are often crushed up to create teas."
      - if: encyclopedia_the_light
        then:
          - "The Light: The Dome and first few layers of the Tunnel are permeated with a permanent light. The light fades quickly over short distances, making the insides of buildings very dark without other lighting sources. People still operate on roughly a 24 hour schedule with many careful timepieces, though the meaning for this exact unit of time has been lost."
  - choice: inventory
    action:
    effects:
      - switch: _args[0]
        "0":
          - At a glance...
          - "\tTraining Pass"
          - To see more detailed options, try something like "inventory plants". Valid options are "plants" to see plants and "prized" to see prized possessions.
        plants:
          - Flowers...
          - "\tRosalia: {rosalia}"
        prized:
          - TODO
        _default:
          - That's not a valid option for inventory. Valid options are "plants" to see plants and "prized" to see prized possessions.
organization:
  flags:
    # Just a block with flags I haven't used yet
    - pass:
    - flag: unlocked_jaz_room
logic:
  time:
    _content:
      - set: time += 1
      - A day passes...
      # Checks for "environment" vars
      - if: 'tunnel_pass == "training" and not on_training_expedition and time_next_training <= time'
        then:
          - set: is_expedition_day = True
          - It's time for you to train in the Tunnel again! Meet George in his room.
        else:
          - set: is_expedition_day = False
      # Unlocks
      - if: time == 10
        then:
          - A new book has arrived at the orphanage study.
          - flag: orphanage_study_unlocked_reading_1
      # Random logic things
      - set: orphanage_rooms_george_num_times_nvm_in_a_row = 0
      - set: orphanage_rooms_george_num_times_chatted_things_in_a_row = 0
      # Return
      - separator:
      - subreturn:
  text:
    clothes_description:
      _content:
        - if: curr_clothes == "light_gray_plain"
          then:
            - You are currently in your light gray plain outfit.
        - if: curr_clothes == "dark_gray_plain"
          then:
            - You are currently in your dark gray plain outfit.
        - subreturn:
# Common events that aren't tied to a specific story location (uses sub)
world:
  characters:
    orphanage:
      jaz:
        third_work_coin_event:
          _vars:
            - bargain_amount: 0
          _content:
            - flag: orphanage_third_work_jaz_coins_resolved
            - if: orphanage_rooms_jaz_third_work_coin_event_split_choices_went_back
              # Case where Jaz was visited before
              then:
                - She asks, "Okay, what do you think about the 20-10 split?"
              # Case where this is the first time visiting Jaz after the coin thing
              else:
                - "Okay, so I was thinking we could split the coins with me getting 20 and you getting 10. I did most of the work after all. What do you think of that?"
            - goto: split_choices
          split_choices:
            _content:
              - choice: back
                text: Decide later
                effects:
                  # TODO: Change flag names now that this is in its own block
                  - flag: orphanage_rooms_jaz_third_work_coin_event_split_choices_went_back
                  - unflag: orphanage_third_work_jaz_coins_resolved
                  - You tell Jaz you'll think about it and decide later. She frowns and says she expects the coins soon, though.
                  - subreturn:
              - choice: sure
                text: Accept the deal
                cost: 20 coin
                effects:
                  - She says, "Thanks! Pleasure doing business."
                  - subreturn:
              - choice: even
                text: Split the coins 50-50
                require: 15 coin
                effects:
                  - set: bargain_amount = 15
                  - She shakes her head. "There's always a master planner and they deserve more. Here, that's me, don't you get it?"
                  - goto: bargain
              - choice: more
                text: Explain that you deserve 20 coins and her only 10 coins
                require: 10 coin
                effects:
                  - set: bargain_amount = 20
                  - She tilts her head. "You drive a hard bargain. Why do you think you deserve more?"
                  - goto: bargain
              - choice: give
                text: Give her all the 30 coins
                cost: 30 coin
                effects:
                  - Her head jerks back in surprise. "Really? I mean, sure." Then she scoops up all the coins and shows you out before you have time to reconsider.
                  - subreturn:
              - choice: bye
                selectable_once:
                text: Leave with all the coins
                effects:
                  - She yaps out "wait!"
                  - choice: ignore
                    text: Ignore her
                    effects:
                      - flag: orphanage_third_work_jaz_coins_walked_out
                      - subreturn:
                  - choice: reconsider
                    text: Decide to split the coins
                    effects:
                      - You reconsider how much to split.
                      - separator:
                      - goto: .
          bargain:
            _content:
              - choice: threaten
                text: Say that if she doesn't accept the deal, you'll tell on her
                effects:
                  - She drops her mouth open. "You wouldn't!" You stare her down and she accepts the deal.
                  - set: coin -= bargain_amount
                    show:
                  - subreturn:
              - if: bargain_amount == 20
                then:
                  - choice: compromise
                    text: Compromise at 50-50
                    effects:
                      - She accepts and says, "I like your bargaining skills, miss!"
                      - set: coin -= 15
                        show:
                      - subreturn:
              - choice: give_in
                text: Accept the original deal of her getting 20 and you getting 10
                effects:
                  - She calls you a wuss and takes her share of the coins grinning. Then, she boots you out.
                  - set: coin -= 20
                    show:
                  - subreturn:
              - if: bargain_amount == 15
                then:
                  - choice: fairness
                    selectable_once:
                    text: Appeal to fairness
                    effects:
                      - She shakes her head and says, "Life isn't fair, I thought you would have learned that by now?"
                      - separator:
                      - goto: .
orphanage:
  _content:
    - set: on_training_expedition = False # TODO: Do I need to make sure training expedition is false anywhere else?
    - if: is_expedition_day # Skip work if it's expedition time
      then:
        - goto: rooms/personal
    # Evaluate events for returning to orphanage here
    - if: time % 7 == 3 # Tuesday is work day (at least initially)
      then:
        - goto: days/work
    - if: time % 7 == 4 # Wednesday is free day
      then:
        - Today is free day at the orphanage. The only day you have to yourself. You can go wander around the halls if you want.
    - if: time % 7 == 5 # Thursday is work day again
      then:
        - goto: days/work
    - if: time % 7 == 6 # Friday is yet another work day
      then:
        - goto: days/work
    # Saturday/Sunday special?
    - goto: rooms/personal
  admin:
    _content:
      - pass:
  common:
    _content:
      - You're in the common hallway.
      - choice: rooms
        text: Go to the bedrooms
      - choice: study
        text: Visit the orphanage's study
      - if: unlocked_courtyard_key
        then:
          - choice: courtyard
            text: Go to the courtyard
      #- choice: courtyard
      #  text: Visit the orphanage's courtyard
    study:
      _content:
        - if: not met_mabel
          then:
            - flag: met_mabel
            - A young, thin woman looks up from a desk at the front of the orphanage's study. "I'm Mabel. I heard you have started exploring. It would only make sense to give you access to our dismal collection of knowledge and folklore surrounding the Tunnel. You'll have to get access to the main town library for more in-depth knowledge. Just choose a subject to study and you can make progress on that book."
          else:
            - Mabel stares at you briefly, as if suspicious of what you might do next, before returning to her dusty book.
        - if: study_on_expedition_day_undo
          then:
            - You have a feeling that studying today would be have grave consequences, so you decide to leave.
            - separator:
            - goto: ..
        - choice: common
          text: Return to the commons area
          effects: ..
        - choice: botany
          text: Read the textbook on Botany I
          effects:
            - goto: botany_1
        - if: orphanage_study_unlocked_reading_1
          then:
            - choice: reading
              text: Read the textbook on Reading I
              effects:
                - goto: reading_1
        - inject: miss_expedition_inject
          into_choices: botany reading
      miss_expedition_inject:
        _content:
          - if: is_expedition_day
            then:
              - goto: miss_expedition
      miss_expedition:
        _content:
          - You might miss your expedition with George if you spend the day reading. Are you sure?
          - choice: "yes"
            effects:
              - George abandons you and you grow up, get kicked out of the orphanage, then starve.
              - I guess you're just not cut out for Tunneling are ya?
              - The End
              - flag: study_on_expedition_day_undo
              - choice: undo
                effects: ../..
          - choice: "no"
            effects: ..
      botany_1:
        _content:
          - You spend the day reading about plants.
          - switch: research_botany_1_chapter
            "0":
              - The first section is just a preface about the beauty of plants in the Tunnel. It goes over the author's love for the different flowers, which is why this first volume of his series on plants is devoted to them. They are also the most common useful type of plant to gather from the first layer of the Tunnel, which is why it's important to learn about them.
            "1":
              - The next section is the first real chapter. It goes over lemens. You remember these from your trip with George, but the book also mentions how they have never been successfully grown in the Dome. This has led many to believe there is a special aura in the Tunnel that keep them alive. You know there's a special aura though, you could feel it.
              - At the very least, it goes over some better techniques for gathering them for next time you're out there.
              - set: skill_lemen += 1
                show:
            "2":
              # TODO: Also increase harvesting skill
              - The third section is about rosalia. You gain an appreciation for how different leaves taste different, with the smallest hardest-to-get ones actually being the most potent and tasteful.
          - set: research_botany_1_chapter += 1
          - choice: next
            effects:
              - sub: /logic/time
              - goto: /orphanage
      reading_1:
        _content:
          - You spend the day reading about reading.
          - switch: research_reading_1_chapter
            "1":
              - The first chapter is a bit basic, you already know the alphabet and a good number of words, which is all it goes over.
          - set: research_reading_1_chapter += 1
          - choice: next
            effects:
              - sub: /logic/time
              - goto: /orphanage
    courtyard:
      _content:
        - The courtyard holds the small graveyard and a pond surrounded by slimy stones. The water is stagnant full of algae. You've never seen fish in it.
        - choice: common
          text: Go back to the commons hallway
          effects: ..
        - choice: read
          text: Read the graves
          effects:
            - The older gravestones from back when the orphanage was prosperous have very ornate carvings, but recent ones don't even have the name of the deceased.
            - separator:
            - goto: .
        - choice: pond
          text: Examine the pond
          effects:
            - You check if a fish has magically appeared in the pond today, but there still aren't any there.
            - separator:
            - goto: .
  lobby:
    _content:
      - You're in the lobby.
      - choice: admin
        text: Go to the administrative area
        effects:
          - You're not allowed there.
          - separator:
          - goto: .
      - choice: common
        text: Go to the commons hallway
      - choice: rooms
        text: Go to the bedrooms
      - choice: town
        text: Go into town
        effects:
          - You're not allowed into town yet.
          - separator:
          - goto: .
  rooms:
    _content:
      - You stand in the hallway where the orphanage bedrooms are. There are 7 bedrooms, and as usual, they're all full. You're at the very beginning, close to the administrative offices on the other end across the lobby. The lobby also opens up to another hallway on the right across from the exit. At the end of all the rooms is a door to the basement.
      #- choice: admin
      #  text: Go to the administrative area
      #  effects:
      #    - You're not allowed there.
      #    - separator:
      #    - goto: .
      #- choice: lobby
      #  text: Go to the lobby
      - choice: common
        text: Go to the commons hallway on the right
      - choice: personal
        text: Visit my own room
      - if: unlocked_george_room
        then:
          - choice: george
            text: Visit George's room
            effects: george/knock
      # TODO: Ways to unlock these rooms
      #- choice: caroline
      #  text: Visit Caroline's room
      #- choice: benedict
      #  text: Visit Benedict's room
      #- choice: rose
      #  text: Visit Rose's room
      - if: unlocked_chloe_room
        then:
          - choice: chloe
            text: Visit Chloe's room
      - if: unlocked_jaz_room
        then:
          - choice: jaz
            text: Visit Jaz's room
    personal:
      _vars:
        - last_time_made_bed: 0
      _content:
        - if: is_expedition_day
          then:
            - You're in your room, which is mostly empty since most things are packed up for exploring.
          else:
            - You're in your room.
        - if: (time - last_time_made_bed) == 0
          then:
            - Your bed is pristine and neatly tucked.
        - if: (time - last_time_made_bed) >= 1 and (time - last_time_made_bed) < 7
          then:
            - Your bed is pretty neat. The covers are a little shifted but it looks pretty nice.
        - if: (time - last_time_made_bed) >= 7 and (time - last_time_made_bed) < 30
          then:
            - Your bed a little messy. There is a bit of the sheet poking out where it should be tucked in and there are some crinkles in the cover.
        - if: (time - last_time_made_bed) >= 30
          then:
            - Your bed is pretty much completely untucked, the covers are thrown off, and the mattress sheet is no longer on one of the corners of the mattress.
        - choice: leave
          text: Leave your room
          effects: ..
        - choice: sleep
          text: Sleep the day away
          effects:
            - if: is_expedition_day
              then:
                - You're too excited for the expedition to sleep!
                - goto: .
            - set: orphanage_rooms_personal_last_day_slept = time
            - sub: /logic/time
            - goto: /orphanage
        - choice: look
          text: Look around the room
          effects:
            - if: orphanage_rooms_personal_looked_around
              then:
                - The room is still as it was, your bed against the far wall with the window, your dresser next to your door, and your desk over on the right.
              else:
                - flag: orphanage_rooms_personal_looked_around
                - Opposite the door, there is your bed, with a window on the far wall bringing in light from the courtyard. To the right of the door is a dresser, and then on the right far wall a table with a chair to study.
                - There is barely enough room to sit down in the remaining space, and sometimes your feet dangle off the bed onto your desk, especially as you've grown older. But it's a place to live and that's enough.
            - separator:
            - goto: .
        # Offer options to sit or examine dresser if they've looked around
        - if: orphanage_rooms_personal_looked_around
          then:
            - choice: sit
              text: Sit at the desk
              effects:
                # TODO: Change description with environment/age?
                - You sit at the desk and stare out at the window. You can partially see your reflection in the dusty window. It's hard to distinguish between the freckles and specks of dirt on your face, and your flaming red hair is messy and knotted.
                - separator:
                - goto: .
            - choice: change
              text: Change clothes
              effects:
                - What would you like to change into?
                - sub: /logic/text/clothes_description
                - choice: stay
                  text: Stay in the same clothes you're wearing now
                  effects:
                    - goto: .
                - if: curr_clothes != "light_gray_plain" and clothes_owned_light_gray_plain
                  then:
                    - choice: light_gray
                      text: Light Gray Plain Outfit
                      effects:
                        - set: curr_clothes = "light_gray_plain"
                        - You change into your new clothes.
                        - separator:
                        - goto: .
                - if: curr_clothes != "dark_gray_plain" and clothes_owned_dark_gray_plain
                  then:
                    - choice: dark_gray
                      text: Dark Gray Plain Outfit
                      effects:
                        - set: curr_clothes = "dark_gray_plain"
                        - You change into your new clothes.
                        - separator:
                        - goto: .
        - if: time - last_time_made_bed > 0
          then:
            - choice: make_bed
              text: Make your bed
              effects:
                - if: is_expedition_day
                  then:
                    - You have no time to make your bed. It's time for an expedition with George!
                  else:
                    - You make your bed.
                    - set: last_time_made_bed = time
                - separator:
                - goto: .
    george:
      _vars:
        - num_times_nvm_in_a_row: 0
      _content:
        - George asks what you would like.
        - if: is_expedition_day
          then:
            - choice: embark
              text: Go on your next venture into the Tunnel
              effects:
                - set: on_training_expedition = True
                - set: num_training_expeditions += 1
                # Switch on the number of visits plus one goes to the expedition number, since the first expedition was from the start label
                - switch: num_training_expeditions
                  "1": /tunnel/training/second_journey
        #- choice: explore
        #  text:
        - if: not is_expedition_day
          then:
            - choice: training
              text: Ask when the next training in the Tunnel is
              effects:
                - set: temp = time_next_training - time
                - if: temp <= 0
                  then:
                    - He says it's time, and he's ready to go when you are.
                  else:
                    - He says it's in {temp} days.
                - separator:
                - goto: .
            - choice: chat
              text: Chat with him
      knock:
        _content:
          - You knock on George's door. He opens it and answers.
          - goto: ..
      chat:
        _content:
          - What would you like to chat with him about?
          - if: orphanage_rooms_george_num_times_nvm_in_a_row < 3
            then:
              - choice: nvm
                text: I don't actually want to talk to him
                effects:
                  - set: orphanage_rooms_george_num_times_nvm_in_a_row += 1
                  - if: orphanage_rooms_george_num_times_nvm_in_a_row == 2
                    then:
                      - George says, "It's fine if you don't want to chat, I won't be offended."
                      - separator:
                  - if: orphanage_rooms_george_num_times_nvm_in_a_row == 3
                    then:
                      - George rolls his eyes. "Do you want to chat or not?"
                      - separator:
                  - goto: ..
          - choice: parents
            selectable_once:
            text: Ask him about his parents
            effects:
              - George tells you, "Oh, I never got to know my mother, died when I was a child, but my dad talked highly of her. Beautiful black hair and green eyes. I didn't care much to hear about her but loved my dad."
              - He goes on, "He was a Tunnel adventurer like me, a great one too. Sorta like me." Then George smiles weakly. "Anyways, he didn't come back one day. Still don't know why, but that's how it goes with the Tunnel..."
              - separator:
              - goto: ..
          - choice: things
            text: Talk about things and stuff
            effects:
              - set: orphanage_rooms_george_num_times_chatted_things_in_a_row += 1
              - It's easy to talk about things and stuff with George. He's the most similar to you at the orphanage with his grand dreams of Tunnel exploring. And he's your closest friend here too.
              - The conversation feels warm and flows smoothly along. Before you know it, a good bit of time has passed.
              - if: orphanage_rooms_george_num_times_chatted_things_in_a_row == 3
                then:
                  - In fact, you've chatted so much, that a whole day has passed. As the sun sets, you head off to bed.
                  - sub: /logic/time
                  - goto: /orphanage
                else:
                  - separator:
                  - goto: ..
    caroline:
      _content:
        - Caroline is a cheerful woman with long black hair. Her hair has strands that fall out a lot all over her room (though somehow without leaving bald spots). She was cursed with a forever-child curse and must now be a child her whole life despite being physically an adult. But she really likes playing with all the new stuff you get from the Tunnel, and watching that helps you learn, so, like, give her stuff and get experience.
    benedict:
      _content:
        - pass:
    rose:
      _content:
        - pass:
    chloe:
      _content:
        - if: time % 7 != 4 # Chloe doesn't answer on non-free days
          then:
            - goto: absent
        - if: not first_orphanage_work_day_gave_chloe_rosalia
          then:
            # If it's after the second expedition, Chloe can forgive you
            - if: num_training_expeditions >= 2
              then:
                - Chloe opens the door. She says she was hurt that you didn't give her a rosalia. Maybe you can make it up to her by bringing her 13 lemens?
                - choice: _back
                - choice: give
                  text: Give her 13 lemens
                  cost: 13 lemens
                  effects:
                    - flag: orphanage_rooms_chloe_gave_lemens
                    - You give her 13 of your lemens.
                    - goto: .
              else:
                - Chloe doesn't open the door, but you can hear some rustling inside.
                - separator:
                - goto: ..
        - if: first_orphanage_work_day_gave_chloe_rosalia and not orphanage_rooms_chloe_offer_courtyard_key
          then:
            - Chloe greets you at her door. She says she loves the Rosalia you gave her. She has a key to the courtyard that she'll trade for more Rosalia.
            - flag: orphanage_rooms_chloe_offer_courtyard_key
        - if: orphanage_rooms_chloe_gave_lemens and not orphanage_rooms_chloe_offer_courtyard_key
          then:
            - Chloe greets you at her door. She says she loves the lemens you gave her and they had such a pretty glow! She has a key to the courtyard that she'll trade for some Rosalia.
            - flag: orphanage_rooms_chloe_offer_courtyard_key
        - choice: _back
        - if: orphanage_rooms_chloe_offer_courtyard_key and not unlocked_courtyard_key
          then:
            - choice: key
              cost: 5 rosalia
              effects:
                - flag: unlocked_courtyard_key
                - separator:
                - goto: .
        - if: unlocked_courtyard_key
          then:
            - Chloe thanks you for giving her the rosalia and says she hopes you enjoy the courtyard.
      absent:
        - Chloe isn't at the door, probably since it's a workday for everyone else at the orphanage.
        - separator:
        - goto: ../..
    jaz:
      _content:
        # After coins event - accepted plan, before coins resolved
        - if: orphanage_third_work_accepted_jaz_coins and not orphanage_third_work_jaz_coins_resolved
          then:
            - Jaz opens the door just a crack and looks through. "Is anyone else there?" She whispers. You answer that it's just you and she lets you in.
            - sub: /world/characters/orphanage/jaz/third_work_coin_event
            - You leave Jaz's room.
            - separator:
            - goto: ..
        # After coins event - did not accept plan
        - if: not orphanage_third_work_accepted_jaz_coins and not orphanage_third_work_jaz_coins_resolved
          then:
            - She opens the door, but says she won't talk to you until you do one of her plans.
            - separator:
            - goto: ..
        # After coins event and resolving who gets coins
        - if: orphanage_third_work_accepted_jaz_coins and orphanage_third_work_jaz_coins_resolved
          then:
            # Case where you walked out with the coins on Jaz
            - if: orphanage_third_work_jaz_coins_walked_out
              then:
                - Jaz yells out while her door is closed to go away.
              else:
                - Jaz yells out from her room "thanks for the business, but I'm busy now".
            - separator:
            - goto: /orphanage/rooms
  days:
    work:
      _content:
        - Today is a work day at the orphanage.
        - switch: _visits
          "1": first_work
          "2": second_work
          "3": third_work
          "4": fourth_work
          "5": fifth_work
        # Don't do work day if the player explored recently
        #- if: time <= time_last_explored + 1
        #  then:
        #    - However, since you are resting from your recent venture into the Tunnel, you're allowed to rest today.
        #    - goto: /orphanage/rooms/personal
      first_work:
        _content:
          - As usual, you, George, and the other 3 children old enough at the orphanage to work line up in front of the double oak doors while Ms. Bee and Mabel stare down at everyone. Then, they open the doors and lead everyone to the farm a 10 minute walk away.
          - Older residents of Sleepy Hollow Orphanage have to work at Karo's farm. He doesn't pay well for the untrained labor, but the orphanage needs all the money it can get. Of course, you don't get a single coin from it. That's just the cost of having a safe place to live and eat.
          - During lunch break, Chloe, another orphan, sits next to you and asks how your first visit to the tunnel went.
          - flag: unlocked_chloe_room
          - choice: exciting
            effects:
              - You explain how exciting it was to be outside the flat barren ground of the Dome and in a new environment.
              - goto: chloe_response
          - choice: sublime
            effects:
              - You say it's hard to explain just how different and "nature"-y things are in the Tunnel as compared to the Dome. The "essence" of the place is just... well, different.
              - goto: chloe_response
          - choice: short
            effects:
              - You sigh and complain that your trip was too short, but you look forward to going again soon!
              - goto: chloe_response
        chloe_response:
          _content:
            - Chloe rolls her eyes and says she wishes she could go. Because your parents were master tunnel explorers themselves, the orphanage has prioritized its resources in you in the hopes that you'll be similar, bringing back treasures abound. Sometimes, you've noticed the other orphans getting jealous of you and George as a result.
            - Of course, it makes sense when you two are the only ones who don't have to worry about getting kicked out each day. Chloe asks, "Could I at least have something you got from the Tunnel? I just want to know what it looks like."
            - choice: give
              text: Give Chloe one of my Rosalia
              cost: 1 rosalia
              effects:
                - flag: first_orphanage_work_day_gave_chloe_rosalia
                - Chloe smiles from ear to ear. "Thanks!" She chirps.
                - goto: back_to_work
            - choice: nah
              text: Don't give Chloe any Rosalia
              effects:
                - Chloe frowns. The rest of the conversation is somewhat flat.
                - goto: back_to_work
        back_to_work:
          _content:
            - After lunch, you both get back to work. The day ends a bit past the traditional rest period for those in the Dome. The light that permeates the Dome never vanishes, but at least it's easy to block out with buildings, and timepieces are common enough to know when rest is warranted.
            - flag: encyclopedia_the_light
            - "[Encyclopedia Entry: The Light]"
            - choice: next
              effects:
                - sub: /logic/time
                - goto: /orphanage
      second_work:
        _content:
          - You all go back to the farm, kicking off the next week of work. You always dread Thursdays, since it means 6 days of work ahead until the next Wednesday rest day.
          - George nudges you in the side with his elbow, "Hey, look at the bright side, we'll be exploring the Tunnel again tomorrow." Your eyes widen. Your work week won't be as long as you thought it would be. George continues, "Just visit my room tomorrow and we'll head out."
          - The rest of the day goes as normal, sweating as you do farmwork all day.
          - flag: unlocked_george_room
          - choice: next
            effects:
              - sub: /logic/time
              - goto: /orphanage
      third_work:
        _content:
          - flag: unlocked_jaz_room
          - This time at the farm, Jaz, another orphan, approaches you. She's known for being somewhat nefarious, and has been caught several times stealing from the farm. She was almost kicked out of the orphanage.
          - Just like you, her face is covered in freckles, and she's wearing a mischievous grin when she walks up to you in the field. "Hey", she says, "You should help me with something!"
          - choice: reject
            text: Nah
            effects:
              - She gawks, "What?! But you haven't even heard what it was!"
              - choice: listen
                text: Hear her out
                effects: plan
              - choice: nope
                text: Go away
                effects:
                  - She huffs off. Better to stay away than get in trouble with her. The rest of the work day goes smoothly.
                  - choice: next
                    effects:
                      - sub: /logic/time
                      - goto: /orphanage
          - choice: accept
            text: Sure
            effects: plan
        plan:
          _content:
            - She explains the plan... since she gets checked if she stole anything after each shift, she'll do the sneaky swiping some of the farmer's coin, and you'll pocket it for off the farm. "It's genius, trust me!" She exclaims.
            - choice: accept
            - choice: reject
        accept:
          _content:
            - After you accept, she scurries off to find some goods to steal from the farmhouse before lunch. Then, at lunch, she slides you 30 coins. That's quite a lot!
            - set: coin += 30
              show:
            - flag: orphanage_third_work_accepted_jaz_coins
            - At the end of the day, Jaz is checked for coins. Of course, they find none; you have all of them.
            - choice: next
              effects:
                - sub: /logic/time
                - goto: /orphanage
        reject:
          _content:
            - She huffs off, mad that you didn't accept her deal. The rest of the work day goes smoothly.
            - choice: next
              effects:
                - sub: /logic/time
                - goto: /orphanage
      fourth_work:
        _content:
          # Things to happen:
          #   - Jaz asks about coins if you haven't resolved the event yet. Do this at lunch.
          #   - Explain farm more?
          - You arrive at the farm for the next day of work. This time, Ms. Bee, one of the two full-time staff at the orphanage, leads everyone to the farm. It's not a long walk, but today is particularly hot. The seasons hit the Town particularly hard due to its proximity to the Dome, the source of much of the heat fluctuation. The stones heat and cool, causing a temperature rippling effect for everything within its interior.
          # TODO: Unlock for encyclopedia entry about weather in the Dome?
          - goto: karo_talk
        karo_talk:
          _content:
            - Today, you're assigned to harvest grains from the field closest to the farm building. Karo, the owner of the farm comes out to talk to you early in the day. He's a heavy-set man with a black scruffy beard and balding black hair. Despite his weight, he still moves gracefully. Karo asks how the Tunnel's been treating you.
            - choice: wonderful
              effects:
                - You explain that the Tunnel is just a wondrous place and there's really nothing else that compares.
                - goto: karo_son
            - choice: exciting
              effects:
                - Your eyes light up as you talk about the excitement of adventures to somewhere new.
                - goto: karo_son
            - choice: horrendous
              effects:
                - You say your Tunnel adventures have been horrendous... horrendously amazing that is!
                - goto: karo_son
        karo_son:
          _content:
            - Karo nods and tells you, "Just be careful, kid, I lost my son in there." You hadn't heard about this before.
            - choice: ask
              text: Ask Karo about his son
              effects:
                - Karo explains that he doesn't know much, just that his son liked to sneak over into the layer without any a valid pass or even any training just to see what was beyond. Karo warned his son, but he kept going until one day he didn't come back. Karo says, "I still miss him. If you ever find out what happened to him, I'll give you a hefty reward."
                - goto: karo_warning
            - choice: sympathy
              text: Express your sympthy but don't inquire further
              effects:
                - Karo looks off into this distance. "I still miss him. If you ever find out what happened to him, I'll give you a hefty reward."
                - goto: karo_warning
        karo_warning:
          _content:
            - Karo goes on, "Just make sure to always be on a lookout. I know you orphans have a hard life, and I wish I could pay the orphanage more for your work. You have a lot of potential in the Tunnel, but don't feel like you need to do it. It's dangerous out there." Then Karo wanders off.
            - separator:
            - goto: lunch
        lunch:
          _content:
            # If took coins and didn't talk to Jaz yet
            - if: orphanage_third_work_accepted_jaz_coins and not orphanage_third_work_jaz_coins_resolved
              then:
                - sub: /world/characters/orphanage/jaz/third_work_coin_event
            - After lunch, you finish the grueling rest of the day's work.
            - choice: next
              effects:
                - sub: /logic/time
                - goto: /orphanage
      fifth_work:
        _content:
          - pass:
tunnel:
  _header:
    - set: time_last_explored = time
  training:
    first_journey:
      george_waiting:
        _vars:
          - first_choice_made: False
          - second_choice_made: False
          - third_choice_made: False
        _content:
          - George is standing at the dusty entrance to the orphanage, his ruffled brown hair blending with the oak double round-top door that leads outside. He's flipping a doubloon to pass the time as he waits for you to finish packing for your trip to the Tunnel with him.
          - if: not first_choice_made
            then:
              - choice: review
                text: Review your encyclopedia notes on rosalia, which you will be gathering with George
                effects:
                  - set: first_choice_made = True
                  - You're able to navigate to your encyclopedia by typing in "encyclopedia" to the command line. You note that you can also see other actions available by typing "actions", or a complete list of commands by typing "help".
                  - You keep in mind to always check your encyclopedia when you get a new entry, since the entries explain important game mechanics, and often include some lore as well!
                  - separator:
                  - goto: .
          - if: not second_choice_made
            then:
              - choice: check
                text: Check that you have your training pass, which is required for entering the Tunnel
                effects:
                  - set: second_choice_made = True
                  - You can see easily by typing in "inventory" to the command line that you have your training pass with you.
                  - separator:
                  - goto: .
          - if: not third_choice_made
            then:
              - choice: touch
                text: Touch the necklace my parents gave me for comfort
                effects:
                  - set: third_choice_made = True
                  - The necklace is all you have left of your parents. You remember little of them.
                  - On the other hand, the hairs knotted to the necklace are tied to a vivid memory. An orphan girl wailing just outside the doorway for a room in winter. Usually, the temperature in the Dome wasn't too bad, but that year was brutal. Director Dicky, the owner of the orphanage, refused to let her in since the place was already so full, and she later became unresponsive and motionless. To his credit, Dicky did let her in at last... to a small graveyard in the orphanage.
                  - You vow to become a great Tunnel explorer, someone who brings back riches and glory. That way, you can provide the funds for anyone to be taken in. You snuck a lock of hair you cut from the poor girl's head as a symbol of your promise.
                  - separator:
                  - goto: .
          - choice: ready
            text: Tell George that I'm ready
            effects:
              - set: on_training_expedition = True
              - goto: leave_orphanage
      leave_orphanage:
        _content:
          - George opens the doors, allowing the light that permeates the outside of the Dome to flood in.
          - You hunker along with your heavy packs, heading for the gaping miles-wide gap in the Dome's rocky walls. It's the Tunnel, which is the only way out, and today will be your first day exploring it.
          - It's only a day's walk from your small town to the Tunnel.
          - choice: walk
            text: Walk with George to the Tunnel
            effects:
              - sub: /logic/time
              - goto: tunnel_entrance
      tunnel_entrance:
        _content:
          - You reach the entrance to the Tunnel, the only exit from the 100-mile or so Dome to which humanity is confined. From here, you finally get a sense of its true magnitude. It's about half a day's walk from one side to the other, but its width is still nothing compared to its depth. No one has gotten to the end, or at least, no one has gotten to the end and returned. Some even think it never ends. Maybe you'll be the first to prove them wrong.
          - "A guard to the entrance booth checks George's Yellow Pass and your Training Pass. There are multiple reasons for the 10-foot stone wall that bars those without passes from getting through: safety, bureaucracy, tradition, preservation. All you care for, though, is to finally see the lush rolling landscape of the first layer."
          - George is unusually adept at Tunnel exploration. Despite only being only a Yellow Pass holder (already a feat for a 19-year-old like him), he was allowed via special agreement to train you. Also due to his natural ability, it doesn't take long for you both to find a rosalia patch.
          - choice: gather
            text: Gather rosalia with George
            effects: gather_rosalia
      gather_rosalia:
        _content:
          # TODO: Use scraps explanation
          - sub: /logic/time
          - George teaches you how to pluck the small leaves from the red flower for use in teas. You already know some about it due to Mabel's love for it. The orphanage's study doesn't hold many books, but she often goes out of her way to find more for those who are able to fetch her some rosalia.
          - set: rosalia += 3
            show:
          - After a day's work of gathering rosalia, George tells you its time to head home. You're disappointed that your first journey was so short, but he explains he just wanted somethings simple the first time. Then he pats you on the back and says, "You did great".
          - choice: return
            text: Return to the orphanage
            effects: return
      return:
        _content:
          - set: time_next_training = time + 4
          - sub: /logic/time
          - Despite the short trip, you feel exhaustion kick in as soon as you get back to the orphanage. Both you and George go straight to bed.
          - choice: next
            effects: /orphanage
    second_journey:
      _content:
        - You tighten your straps of your pack for your second ever journey into the tunnel. George grins freckled cheek to freckled cheek. "I'm so excited to show you the lemen fields!" He exclaims. "The whatnow?" You ask. "You'll see," George assures you.
        - And with that, you're off!
        - separator:
        - sub: /logic/time
        - George shows his Yellow Pass to the guard, and you hold up your white Training Pass. The guard examines the passes and lets you both through.
        - You spend another day just walking to the spot where George wants to go. You don't even reach the place by nightfall, though George seems to have had a river in mind as a water-source at least.
        - separator:
        - sub: /logic/time
        - The next day, after about 30 minutes of walking, he starts to hike up a steep hill. The Dome is comparatively flat, so you're not used to the steep elevation. George, on the other hand, is able to speed ahead. You're afraid to lose him, but he stops at the top. Then, he turns to look down at you and yells out, "Don't worry, when I was your age, my stamina wasn't so great either." Then he chuckles. "You'll do just fine."
        - He makes it sound like he's had soooo much more time to progress, but really he's only three years older than you.
        - Once you get to the top, you slouch your hands onto your knees and wheeze in and out. When you're done panting, you look up and drop your mouth.
        - choice: next
          effects: harvest
      harvest:
        _content:
          - In front of you is the largest field of flowers that you've ever seen. And it's glowing! George announces proudly, "I just wanted to show you the lemen patch I always like to use. She's a beauty." He goes on, explaining what lemens are... a bulbous, yellow, luminous plant that dims over time. Also, they're used for lighting across the dome.
          - You ask, "So those bright bulb-y things are what gets put in the orphanage for lighting? But the ones down there are so much brighter." George explains, "Ah, but we usually use cheaper secondhand lemens. I sell the fresh ones I gather for a higher price." To be fair, the lighting is probably one of the smaller concerns at the orphanage anyways.
          - George and you split up to gather lemens. He says lemen-bushels is a good amount. As you start, you notice some rosalia off in the distance.
          - choice: snatch
            text: Snatch some rosalia quickly
            effects:
              - You don't gather as many lemens because the rosalia was a lot further away than you expected. At least you get some rosalia.
              - flag: training_second_journey_gathered_rosalia
              - set: lemens += skill_lemen
                show:
              - set: rosalia += 3
                show:
              - goto: reconvene
          - choice: focus
            text: Focus on gathering the lemens
            effects:
              - You focus on gathering the lemens and are able to be quite productive.
              - set: lemens += 3 * skill_lemen
                show:
              - goto: reconvene
      reconvene:
        _content:
          - You reconvene with George.
          - if: training_second_journey_gathered_rosalia
            then:
              - George notices you didn't gather as many lemens as him, so he offers some of his.
              - choice: tell
                text: Tell George about getting distracted by the rosalia
                effects:
                  # TODO: A later encounter that is dangerous/has consequences if you wander off
                  - George frowns. "You should follow my lead in the Tunnel, things can get dangerous if you wander off to other places."
                  - goto: leave
              - choice: silent
                text: Stay silent about the rosalia
                effects:
                  - George hands you half of his lemens. He has a lot of lemens.
                  - set: lemens += 12
                    show:
                  - goto: leave
            else:
              - goto: leave
      leave:
        _content:
          - separator:
          - sub: /logic/time
          - The next day, it's time to head back. You feel sad, but this time you got to spend almost a whole week away from the orphanage, so you really can't complain.
          - choice: return
            effects:
              # Technically, it should take 2 days to get back, but it's more convenient to the plot to do only 1 since then they can come back on a workday
              - set: time_next_training = time + 6
              - sub: /logic/time
              - separator:
              - goto: /orphanage
